<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mon Compte | ReCore</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">

<style>
.resend-btn {
    padding: 6px 12px;
    border-radius: 10px;
    border: 1px solid #3a3a44;
    background: #2a2a33;
    color: #f5f5f7;
    font-size: 0.8rem;
    cursor: pointer;
    transition: 0.2s;
}
.resend-btn:hover { opacity: 0.85; }
.resend-btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
</head>
<body>

<header class="navbar">
    <div class="logo">ReCore</div>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="brand.html">Brand</a>
        <a href="produits.html">Produits</a>
        <a href="contact.html">Contact</a>
        <a href="compte.html">Mon compte</a>
        <a href="panier.html" class="cart-inline">
            ðŸ›’ <span class="cart-count" id="cart-count">0</span>
        </a>
    </nav>
</header>

<section class="page-hero">
    <h1>Mon Compte</h1>
    <p id="status">Chargement...</p>
</section>

<section class="section">
    <div class="account-card" id="account-info" style="display:none;">

        <div class="account-row">
            <span class="label">Nom</span>
            <input type="text" id="nom" disabled>
        </div>

        <div class="account-row">
            <span class="label">PrÃ©nom</span>
            <input type="text" id="prenom" disabled>
        </div>

        <div class="account-row">
            <span class="label">Adresse</span>
            <input type="text" id="adresse" disabled>
        </div>

        <div class="account-row">
            <span class="label">Email</span>
            <div class="email-container">
                <input type="email" id="email" disabled>
                <span id="email-badge" class="badge"></span>
                <button id="resendBtn" class="resend-btn" style="display:none;" onclick="resendVerification()">
                    Renvoyer
                </button>
            </div>
        </div>

        <div class="account-actions">
            <button class="btn" onclick="enableEdit()">Modifier</button>
            <button class="btn" id="saveBtn" style="display:none;" onclick="saveProfile()">Sauvegarder</button>
            <button class="btn" onclick="logout()">DÃ©connexion</button>
        </div>

    </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, sendEmailVerification } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvmqa7MUYKePUHSYq69XmhN9N7GdNvlPU",
  authDomain: "recore-f320c.firebaseapp.com",
  projectId: "recore-f320c",
  storageBucket: "recore-f320c.firebasestorage.app",
  messagingSenderId: "560442114914",
  appId: "1:560442114914:web:9c2bf7f43f3336954ca23b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }

    currentUser = user;

    document.getElementById("status").innerText = "Bienvenue ðŸ‘‹";
    document.getElementById("account-info").style.display = "block";

    const docRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("nom").value = data.nom || "";
        document.getElementById("prenom").value = data.prenom || "";
        document.getElementById("adresse").value = data.adresse || "";
        document.getElementById("email").value = data.email || user.email;
    }

    const badge = document.getElementById("email-badge");
    const resendBtn = document.getElementById("resendBtn");

    badge.classList.remove("verified", "not-verified");

    if (user.emailVerified) {
        badge.innerText = "VÃ©rifiÃ©";
        badge.classList.add("verified");
        resendBtn.style.display = "none";
    } else {
        badge.innerText = "Non vÃ©rifiÃ©";
        badge.classList.add("not-verified");
        resendBtn.style.display = "inline-block";
    }
});

window.enableEdit = function() {
    document.getElementById("nom").disabled = false;
    document.getElementById("prenom").disabled = false;
    document.getElementById("adresse").disabled = false;
    document.getElementById("saveBtn").style.display = "inline-block";
};

window.saveProfile = async function() {
    try {
        await updateDoc(doc(db, "users", currentUser.uid), {
            nom: document.getElementById("nom").value,
            prenom: document.getElementById("prenom").value,
            adresse: document.getElementById("adresse").value
        });

        document.getElementById("nom").disabled = true;
        document.getElementById("prenom").disabled = true;
        document.getElementById("adresse").disabled = true;
        document.getElementById("saveBtn").style.display = "none";

        showToast("Profil mis Ã  jour âœ”", "success");
    } catch (error) {
        console.error(error);
        showToast("Erreur lors de la mise Ã  jour âŒ", "error");
    }
};

window.resendVerification = async function() {
    try {
        const resendBtn = document.getElementById("resendBtn");
        resendBtn.disabled = true;

        await sendEmailVerification(currentUser);
        showToast("Email de vÃ©rification renvoyÃ© ðŸ“©", "success");

        setTimeout(() => {
            resendBtn.disabled = false;
        }, 30000);
    } catch (error) {
        console.error(error);
        showToast("Impossible de renvoyer l'email âŒ", "error");
        document.getElementById("resendBtn").disabled = false;
    }
};

window.logout = function() {
    signOut(auth);
    window.location.href = "login.html";
};

function showToast(message, type) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.classList.remove("success", "error");
    toast.classList.add("show");

    if (type === "success") toast.classList.add("success");
    if (type === "error") toast.classList.add("error");

    setTimeout(() => {
        toast.classList.remove("show");
    }, 2500);
}
</script>

<script>
window.addEventListener("load", () => {
    document.body.classList.add("page-loaded");
});

document.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", function(e) {
        const href = this.getAttribute("href");

        if (!href || href.startsWith("#") || href.startsWith("http")) return;

        e.preventDefault();

        document.body.classList.remove("page-loaded");
        document.body.classList.add("fade-out");

        setTimeout(() => {
            window.location.href = href;
        }, 400);
    });
});
</script>

<div id="toast" class="toast"></div>
</body>
</html>
